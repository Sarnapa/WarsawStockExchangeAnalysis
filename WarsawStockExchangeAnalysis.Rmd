---
title: "Nie warto inwestować na Warszawskiej Giełdzie Papierów Wartościowych"
subtitle: "Jest to znacznie bardziej ryzykowne niż skorzystanie z usług funduszy inwestycyjnych"
author: "Michał Piotrak, Jakub Proboszcz"
date: "2023-03-16"
output: xaringan::moon_reader
---

```{css, echo = FALSE}
body { font-family: 'Comic Sans', serif; }
```

```{r, echo=FALSE, message=FALSE}
require(tidyverse)
require(scales)
```

```{r, echo=FALSE, message=FALSE}
read_data <- function(csv_file) {
  data <- read_csv(csv_file) %>% 
    mutate(Year = year(Data)) %>% 
    select(Year, Open = Otwarcie, Close = Zamkniecie) %>%
    arrange(Year)
}

wig_df <- read_data("wig_y.csv")
fund1429_df <- read_data("1429_n_y.csv")
fund1655_df <- read_data("1655_n_y.csv")
fund2162_df <- read_data("2162_n_y.csv")

calculate_annual_returns <- function(df, instrument) {
  df %>%
    mutate(ReturnRate = (Close / Open) - 1, ReturnLogRate = log(Close / Open)) %>%
    select(Year, ReturnRate, ReturnLogRate) %>%
    add_column(Instrument = instrument)
}

# Obliczenie stóp zwrotu dla wskaźnika WIG oraz funduszy inwestycyjnych
wig_ar_df <- calculate_annual_returns(wig_df, "WIG")
fund1429_ar_df <- calculate_annual_returns(fund1429_df, "Allianz FIO")
fund1655_ar_df <- calculate_annual_returns(fund1655_df, "Ipopema SFIO")
fund2162_ar_df <- calculate_annual_returns(fund2162_df, "Credit Agricole FIO")

# Funkcja do wyliczania statystyk w danym okresie dla podanego wskaźnika bądź funduszu
get_stats_for_period <- function(instrument, ar_df, years) {
  # Maksymalny dostępny rok
  max_year <- max(ar_df$Year)

  # Wybranie ostatnich 'n' lat
  selected_df <- ar_df %>%
    filter(Year > (max_year - years))

  # Obliczenie statystyk
  cumulative_rr <- exp(sum(selected_df$ReturnLogRate, na.rm = TRUE)) - 1
  rr_mean <- mean(selected_df$ReturnRate, na.rm = TRUE)
  rr_sd <- sd(selected_df$ReturnRate, na.rm = TRUE)
  # Współczynnik zmienności
  cv <- rr_sd / rr_mean
  
  # Zwracanie jako tibble
  tibble(
    Instrument = instrument,
    Years = as.factor(years),
    CumulativeReturnRate = round(cumulative_rr, 4),
    AnnualReturnRateAvg = round(rr_mean, 4),
    AnnualReturnRateSd = round(rr_sd, 4),
    CoefficientOfVariation = round(cv, 4)
  )
}

periods <- c(3, 5, 10)
instruments <- c("WIG", "1429.N", "1655.N", "2162.N")
wig_stats_df <- map_dfr(periods, ~get_stats_for_period(instruments[1], wig_ar_df, .x))
fund1429_stats_df <- map_dfr(periods, ~get_stats_for_period(instruments[2], fund1429_ar_df, .x))
fund1655_stats_df <- map_dfr(periods, ~get_stats_for_period(instruments[3], fund1655_ar_df, .x))
fund2162_stats_df <- map_dfr(periods, ~get_stats_for_period(instruments[4], fund2162_ar_df, .x))

all_instruments_stats_df <- bind_rows(wig_stats_df, fund1429_stats_df, fund1655_stats_df, fund2162_stats_df)
all_instruments_stats_df <- all_instruments_stats_df %>%
  mutate(Instrument = factor(Instrument, levels = instruments))

# print(all_instruments_stats_df)

# Funkcja do wizualizacji wykresu, gdzie dla 3 okresów pokazujemy, jak się zmieniały dane statystyki dla dostarczonych instrumentów finansowych
visualize_all_instruments_stats_chart <- function(y_param, title, y_lab) {
  ggplot(all_instruments_stats_df, aes(x = Instrument, y = y_param, fill = Years)) +
    geom_col(position = "dodge") +
    labs(
      title = title,
      x = NULL,
      y = y_lab,
      fill = "Okres inwestycji"
    ) +
    scale_fill_manual(
      values = c(
        "3" = "#2E75B6",
        "5" = "#C55A11",
        "10" = "#A5A5A5"
      ),
      labels = c("3 lata", "5 lat", "10 lat")
    ) +
    theme_light() +
    theme(plot.title = element_text(face = "bold", hjust = 0.5))
}
```

```{r, echo=FALSE, fig.width=10, fig.height=6}

all_ar_df <- rbind(wig_ar_df, fund1429_ar_df, fund1655_ar_df, fund2162_ar_df)

ggplot(all_ar_df, aes(x = Year, y = ReturnRate, color = Instrument)) +
  geom_line() + 
  scale_x_continuous(breaks = 2015:2024) + 
  labs(
    title = "Roczna stopa zwrotu dla WIG oraz trzech wybranych funduszy inwestycyjnych",
    subtitle = "w latach 2015-2024",
    x = "Rok",
    y = "Roczna stopa zwrotu",
  )
```

<font size="4">Powyższy wykres przedstawia roczne stopy zwrotu dla indeksu WIG oraz 3 funduszy inwestycyjnych. Jak widać, średnie zyski są podobne dla wszystkich tych opcji inwestowania, jednakże zarówno zyski, jak i straty są zauważalnie większe dla WIG.</font><br><br>

<font size="4">Średnia roczna stopa zwrotu dla WIG wynosi `r round(mean(wig_ar_df$ReturnRate), 4) * 100`%, a dla trzech wybranych funduszy `r round(mean(c(fund1429_ar_df$ReturnRate, fund1655_ar_df$ReturnRate, fund2162_ar_df$ReturnRate)), 4)*100`%.</font>


---


```{r, echo=FALSE}
visualize_all_instruments_stats_chart(all_instruments_stats_df$CumulativeReturnRate, "Skumulowana stopa zwrotu za dany okres", "Skumulowana stopa zwrotu")
```

---

```{r, echo=FALSE}
visualize_all_instruments_stats_chart(all_instruments_stats_df$AnnualReturnRateAvg, "Średnia roczna stopa zwrotu za dany okres", "Średnia roczna stopa zwrotu")
```

---

```{r, echo=FALSE}
visualize_all_instruments_stats_chart(all_instruments_stats_df$AnnualReturnRateSd, "Odchylenie standardowe rocznej stopy zwrotu za dany okres", "Odchylenie standardowe")
```

```{r, echo=FALSE}
# Funkcja do wizualizacji wykresu, gdzie pokazujemy zależność stopa zwrotu - odchylenie standardowe w konkretnym okresie dla dostarczonych instrumentów finansowych
visualize_all_instruments_rr_sd_chart <- function(period) {
  all_instruments_period_stats_df <- all_instruments_stats_df %>%
    filter(Years == period)
    ggplot(all_instruments_period_stats_df, aes(x = CumulativeReturnRate, y = AnnualReturnRateSd, label = Instrument)) + 
    geom_point(size = 3, color = "#2E75B6") +
    geom_text(vjust = -0.8, size = 4) +
    labs(
      title = paste("Zysk vs ryzyko – okres", period, "lat"),
      x = "Skumulowana stopa zwrotu",
      y = "Odchylenie standardowe"
      ) +
    scale_x_continuous(expand = expansion(mult = c(0.1, 0.1))) +
    scale_y_continuous(expand = expansion(mult = c(0.1, 0.1))) +
    theme_light() +
    theme(plot.title = element_text(face = "bold", hjust = 0.5))
}
```

---

```{r, echo=FALSE}
visualize_all_instruments_rr_sd_chart(periods[1])
```

---

```{r, echo=FALSE}
visualize_all_instruments_rr_sd_chart(periods[2])
```

---

```{r, echo=FALSE}
visualize_all_instruments_rr_sd_chart(periods[3])
```

```{r, echo=FALSE}
# Funkcja do wizualizacji wykresu, gdzie pokazujemy zależność odchylenie standardowe - współczynnik zmienności w konkretnym okresie dla dostarczonych instrumentów finansowych
visualize_all_instruments_sd_cv_chart <- function(period) {
  all_instruments_period_stats_df <- all_instruments_stats_df %>%
    filter(Years == period)
    ggplot(all_instruments_period_stats_df, aes(x = AnnualReturnRateSd, y = CoefficientOfVariation, label = Instrument)) + 
    geom_point(size = 3, color = "#2E75B6") +
    geom_text(vjust = -0.8, size = 4) +
    labs(
      title = paste("Współczynnik zmienności – okres", period, "lat"),
      x = "Odchylenie standardowe",
      y = "Współczynnik zmienności"
      ) +
    scale_x_continuous(expand = expansion(mult = c(0.1, 0.1))) +
    scale_y_continuous(expand = expansion(mult = c(0.1, 0.1))) +
    theme_light() +
    theme(plot.title = element_text(face = "bold", hjust = 0.5))
}
```

---

```{r, echo=FALSE}
visualize_all_instruments_sd_cv_chart(periods[1])
```

---

```{r, echo=FALSE}
visualize_all_instruments_sd_cv_chart(periods[2])
```

---

```{r, echo=FALSE}
visualize_all_instruments_sd_cv_chart(periods[3])
```